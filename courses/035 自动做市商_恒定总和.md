#### æ¦‚å¿µ
- æ’å®šæ€»å’Œè‡ªåŠ¨åšå¸‚å•†ï¼ˆCSMM, Constant Sum Market Makerï¼‰
- åœ¨åŒºå—é“¾çš„å»ä¸­å¿ƒåŒ–é‡‘èï¼ˆDeFiï¼‰ä¸­ï¼ŒCSMMæ˜¯å¸¸è§çš„"åšå¸‚å•†æ¨¡å‹"ä¹‹ä¸€ã€‚

ã€€

#### å…¬å¼
- æ’å®šæ€»å’Œåšå¸‚å•†çš„æ ¸å¿ƒå…¬å¼æ˜¯ï¼š ```ğ‘¥ + ğ‘¦ = ğ¶```
- x å’Œ ğ‘¦ï¼Œåˆ†åˆ«ä»£è¡¨æ± ä¸­çš„ä¸¤ç§ä»£å¸çš„æ•°é‡ï¼Œ
- C æ˜¯ä¸€ä¸ªæ’å®šå€¼ã€‚è¿™æ„å‘³ç€ä¸¤ç§ä»£å¸çš„æ•°é‡æ€»å’Œä¸å˜ã€‚

ã€€

#### ç‰¹ç‚¹ï¼š
- æµåŠ¨æ€§æœ‰é™ï¼šä¸€æ—¦æŸç§ä»£å¸çš„æ•°é‡è€—å°½ï¼Œå¦ä¸€ç§ä»£å¸å°±æ— æ³•ç»§ç»­äº¤æ˜“ã€‚å› æ­¤ï¼Œå½“æ± å­ä¸­çš„æŸä¸ªä»£å¸è¢«å®Œå…¨å…‘æ¢å®Œåï¼Œäº¤æ˜“ä¼šåœæ­¢ã€‚
- é›¶æ»‘ç‚¹äº¤æ˜“ï¼šå½“äº¤æ˜“é‡å¾ˆå°æ—¶ï¼ŒCSMM å¯ä»¥æä¾›é›¶æ»‘ç‚¹çš„äº¤æ˜“ï¼Œå› ä¸ºä¸¤ä¸ªä»£å¸çš„æ€»å’Œä¿æŒä¸å˜ã€‚
- é€‚ç”¨åœºæ™¯ï¼šç”±äºæ»‘ç‚¹è¾ƒå°ï¼Œè¿™ç§æ¨¡å‹é€‚åˆç”¨äºç¨³å®šå¸ä¹‹é—´çš„äº¤æ˜“ã€‚æˆ–ï¼ŒæµåŠ¨æ€§è¾ƒä¸ºå‡è¡¡çš„ä»£å¸å¯¹äº¤æ˜“ã€‚

ã€€

#### ç†è§£æ’å®šå’Œ
- åœ¨æ¯æ¬¡swapè¿‡ç¨‹ä¸­ï¼Œç¡®å®ä¿æŒ ```ğ‘¥ + ğ‘¦ = ğ¶```
- åœ¨æ¯æ¬¡addLiquidityåï¼Œ```ğ‘¥ + ğ‘¦``` çš„æ€»é‡å˜ä¸º ğ¶^ï¼Œä½†æ˜¯ï¼Œè¿™å¹¶ä¸æ„å‘³ç€ ```ğ‘¥ + ğ‘¦ = ğ¶``` çš„å…³ç³»è¢«ç ´åäº†
- ä¹‹åä»ç„¶éµå¾ª ```ğ‘¥^ + ğ‘¦^ = ğ¶^```
- æ­¤å¤„è¡¨è¾¾çš„æ˜¯ï¼Œæ–°çš„æ€»é‡ğ¶^ï¼Œæ˜¯æ›´æ–°åçš„å¸¸æ•°ã€‚

ã€€

#### ç¤ºä¾‹ä»£ç ï¼š
```
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.26;

interface IERC20 {
    function totalSupply() external view returns (uint256);
    function balanceOf(address account) external view returns (uint256);
    function transfer(address recipient, uint256 amount)
        external
        returns (bool);
    function allowance(address owner, address spender)
        external
        view
        returns (uint256);
    function approve(address spender, uint256 amount) external returns (bool);
    function transferFrom(address sender, address recipient, uint256 amount)
        external
        returns (bool);
}

contract CSAMM {
    // å®šä¹‰ä¸¤ç§ä»£å¸
    IERC20 public immutable token0;
    IERC20 public immutable token1;

    // åˆ†åˆ«ä¿å­˜ä¸¤ç§ä»£å¸çš„å­˜å‚¨æ•°é‡ï¼Œå³"åˆçº¦çš„ä»£å¸å‚¨å¤‡é‡"
    uint256 public reserve0;
    uint256 public reserve1;

    // æµåŠ¨æ€§æ€»é¢(å®ƒè¶Šå¤šï¼Œä»£è¡¨åšå¸‚å•†åˆçº¦çš„æµåŠ¨æ€§è¶Šå¤§)
    uint256 public totalSupply;

    // è®°å½•æ¯ä¸ªç”¨æˆ·åœ°å€çš„"æµåŠ¨æ€§ä»½é¢"
    mapping(address => uint256) public balanceOf;

    constructor(address _token0, address _token1) {
        // å‡è®¾ token0 å’Œ token1 çš„å°æ•°ä½æ•°ç›¸åŒ
        token0 = IERC20(_token0);
        token1 = IERC20(_token1);
    }

    // å†…éƒ¨å‡½æ•°ï¼šå¢åŠ æŒ‡å®šç”¨æˆ·çš„"æµåŠ¨æ€§ä»½é¢"
    function _mint(address _to, uint256 _amount) private {
        balanceOf[_to] += _amount;
        totalSupply += _amount;
    }

    // å†…éƒ¨å‡½æ•°ï¼šå‡å°‘æŒ‡å®šç”¨æˆ·çš„"æµåŠ¨æ€§ä»½é¢"
    function _burn(address _from, uint256 _amount) private {
        balanceOf[_from] -= _amount;
        totalSupply -= _amount;
    }

    // å†…éƒ¨å‡½æ•°ï¼šæ›´æ–°ä»£å¸å‚¨å¤‡é‡
    function _update(uint256 _res0, uint256 _res1) private {
        reserve0 = _res0;
        reserve1 = _res1;
    }

    // äº¤æ¢å‡½æ•°ï¼šç”¨äºäº¤æ¢ä»£å¸(ä¼šå½±å“"åˆçº¦çš„ä»£å¸å‚¨å¤‡é‡"ï¼Œä¸ä¼šå½±å“ç”¨æˆ·çš„"æµåŠ¨æ€§ä»½é¢")
    function swap(address _tokenIn, uint256 _amountIn)
        external
        returns (uint256 amountOut)
    {
        /*
            - åœ¨è°ƒå–å‰ï¼Œé€šå¸¸ä¼šæç¤ºç”¨æˆ·ï¼Œ"æˆæƒç»™æœ¬åˆçº¦è¶³é¢çš„ä»£å¸"
        */

        require(
            _tokenIn == address(token0) || _tokenIn == address(token1),
            "invalid token"
        );
        require(_amountIn > 0, "amount in = 0");

        bool isToken0 = (_tokenIn == address(token0));

        (IERC20 tokenIn, IERC20 tokenOut, uint256 resIn, uint256 resOut) =
        isToken0
            ? (token0, token1, reserve0, reserve1)
            : (token1, token0, reserve1, reserve0);

        /*
            - äº¤æ¢æ“ä½œï¼Œé€šå¸¸ä¼šäº§ç”Ÿæ‰‹ç»­è´¹ï¼Œæœ¬ç¤ºä¾‹ä¸­ä¸º"åƒåˆ†ä¹‹ä¸‰"

            - ä½¿ç”¨"æ’å®š"å…¬å¼ï¼Œä½œä¸ºæ¨æ¼”å‡ºå‘ç‚¹
            - ğ‘¥ + ğ‘¦ = ğ¶
            resIn + resOut = ğ¶

            ==> (resIn + _amountIn) + (resOut - _amountOut) = ğ¶ = resIn + resOut
            ==> _amountIn - _amountOut = 0
            ==> _amountIn - _amountOut = 0
            ==> _amountOut = _amountIn
            ==> _amountOut = _amountIn * (100% - 0.3%)
            ==> _amountOut = _amountIn * 99.7%
            ==> _amountOut = (_amountIn * 997) / 1000
        */            

        // æŠŠç”¨æˆ·çš„ä»£å¸ï¼Œä½¿ç”¨"æˆæƒè½¬è´¦"åˆ°åˆçº¦
        tokenIn.transferFrom(msg.sender, address(this), _amountIn);
        uint256 amountIn = tokenIn.balanceOf(address(this)) - resIn;

        // fee åƒåˆ†ä¹‹ä¸‰çš„æ‰‹ç»­è´¹
        amountOut = (amountIn * 997) / 1000;

        (uint256 res0, uint256 res1) = isToken0
            ? (resIn + amountIn, resOut - amountOut)
            : (resOut - amountOut, resIn + amountIn);

        // æ›´æ–°æœ¬åˆçº¦çš„ä½™é¢
        _update(res0, res1);

        // æŠŠè®¡ç®—å‡ºçš„Outï¼Œè½¬è´¦ç»™ç”¨æˆ·
        tokenOut.transfer(msg.sender, amountOut);
    }

    // æ·»åŠ æµåŠ¨æ€§å‡½æ•°(ä¼šå½±å“ç”¨æˆ·çš„"æµåŠ¨æ€§ä»½é¢"ï¼Œä¹Ÿä¼šå½±å“"åˆçº¦çš„ä»£å¸å‚¨å¤‡é‡")
    function addLiquidity(uint256 _amount0, uint256 _amount1)
        external
        returns (uint256 shares)
    {
        /*
            - åœ¨è°ƒå–å‰ï¼Œé€šå¸¸ä¼šæç¤ºç”¨æˆ·ï¼Œ"æˆæƒç»™è¯¥åˆçº¦è¶³é¢çš„ä»£å¸"
            - ç”¨æˆ·è®©åˆçº¦æ“æ§è‡ªå·±çš„ä¸¤ç§ä»£å¸ï¼Œä¸ºè‡ªå·±å¢åŠ äº†"æµåŠ¨æ€§ä»½é¢"ï¼Œä¹Ÿå¢åŠ äº†"åˆçº¦çš„ä»£å¸å‚¨å¤‡é‡"
        */

        // æŠŠç”¨æˆ·çš„ä»£å¸ï¼Œä½¿ç”¨"æˆæƒè½¬è´¦"åˆ°åˆçº¦
        token0.transferFrom(msg.sender, address(this), _amount0);
        token1.transferFrom(msg.sender, address(this), _amount1);

        // è·å–å½“å‰åˆçº¦ä¸­ä»£å¸çš„æœ€æ–°ä½™é¢
        uint256 bal0 = token0.balanceOf(address(this));
        uint256 bal1 = token1.balanceOf(address(this));

        // è®¡ç®—æ–°å¢çš„å‚¨å¤‡é‡
        uint256 d0 = bal0 - reserve0;
        uint256 d1 = bal1 - reserve1;

        /*
            - ä½¿ç”¨"å¢é‡æ¯”ä¾‹"å…¬å¼ï¼Œä½œä¸ºæ¨æ¼”å‡ºå‘ç‚¹
            a = ç”¨æˆ·å¸¦æ¥æ–°å¢çš„ä»£å¸æ€»æ•°          (å•ä½ï¼šä»£å¸æ•°é‡)
            L = åˆçº¦çš„ä»£å¸å‚¨å¤‡æ€»é‡             (å•ä½ï¼šä»£å¸æ•°é‡)            
            s = éœ€è¦ä¸ºç”¨æˆ·å¢åŠ çš„"æµåŠ¨æ€§ä»½é¢"    (å•ä½ï¼šæµåŠ¨æ€§ä»½é¢)
            T = æ€»æµåŠ¨æ€§ä»½é¢                   (å•ä½ï¼šæµåŠ¨æ€§ä»½é¢)

            => éµå¾ªåŒä¸€å•ä½åšæ¯”ä¾‹
            => (L + a) / L = (T + s) / T
            => s = a * T / L
        */

        if (totalSupply > 0) {
            shares = ((d0 + d1) * totalSupply) / (reserve0 + reserve1);
        } else {
            shares = d0 + d1;
        }

        require(shares > 0, "shares = 0");

        // ä¸ºç”¨æˆ·å¢åŠ (é“¸é€ )æµåŠ¨æ€§ä»½é¢
        _mint(msg.sender, shares);

        // åˆ·æ–°ä»£å¸å‚¨å¤‡é‡
        _update(bal0, bal1);
    }

    // å‡å°‘æµåŠ¨æ€§å‡½æ•°(ä¼šå½±å“ç”¨æˆ·çš„"æµåŠ¨æ€§ä»½é¢"ï¼Œä¹Ÿä¼šå½±å“"åˆçº¦çš„ä»£å¸å‚¨å¤‡é‡")
    function removeLiquidity(uint256 _shares)
        external
        returns (uint256 d0, uint256 d1)
    {
        /*
            - ä½¿ç”¨"å‡é‡æ¯”ä¾‹"å…¬å¼ï¼Œä½œä¸ºæ¨æ¼”å‡ºå‘ç‚¹
            a = æœ€ç»ˆç”¨æˆ·å‡å»çš„ä»£å¸æ€»æ•°          (å•ä½ï¼šä»£å¸æ•°é‡)
            L = åˆçº¦çš„ä»£å¸å‚¨å¤‡æ€»é‡             (å•ä½ï¼šä»£å¸æ•°é‡)            
            s = éœ€è¦ä¸ºç”¨æˆ·å‡å»çš„"æµåŠ¨æ€§ä»½é¢"    (å•ä½ï¼šæµåŠ¨æ€§ä»½é¢)
            T = æ€»æµåŠ¨æ€§ä»½é¢                   (å•ä½ï¼šæµåŠ¨æ€§ä»½é¢)

            => éµå¾ªåŒä¸€å•ä½åšæ¯”ä¾‹
            => (L - a) / L = (T - s) / T
            => a / L = s / T
            => a = L * s / T
            => (d0 + d1) = (reserve0 + reserve1)* s/T
                         = reserve0*s/T + reserve1*s/T
            => d0 = reserve0*s/T
            => d1 = reserve1*s/T
        */
        d0 = (reserve0 * _shares) / totalSupply;
        d1 = (reserve1 * _shares) / totalSupply;

        // å‡å°‘(é”€æ¯)ç”¨æˆ·çš„æµè¡Œæ€§ä»½é¢
        _burn(msg.sender, _shares);

        // åˆ·æ–°ä»£å¸å‚¨å¤‡é‡
        _update(reserve0 - d0, reserve1 - d1);

        // è¿”è¿˜ç»™ç”¨æˆ·ä»£å¸æ•°é‡
        if (d0 > 0) {
            token0.transfer(msg.sender, d0);
        }
        if (d1 > 0) {
            token1.transfer(msg.sender, d1);
        }
    }

    // æŸ¥è¯¢æŒ‡å®šè´¦æˆ·çš„æµåŠ¨æ€§ä»½é¢   
    function getBalanceOf(address _account) external view returns(uint256) {
        return balanceOf[_account];
    }

    // æŸ¥è¯¢æµåŠ¨æ€§æ€»é¢
    function getTotalSupply() external view returns(uint256) {
        return totalSupply;
    }    
}

```

ã€€

#### ä»£ç é‡ç‚¹ï¼š
- ç†è§£"ä»£å¸æ•°é‡"å•ä½
- ç†è§£"æµåŠ¨æ€§ä»½é¢"å•ä½
- éµå¾ª ```ğ‘¥ + ğ‘¦ = ğ¶```
- éµå¾ª ```ğ‘¥^ + ğ‘¦^ = ğ¶^```
- ```swap```æ“ä½œä¸­ï¼Œä¼šé¢å¤–æ‰£é™¤ç”¨æˆ·çš„ä»£å¸æ•°é‡ï¼Œä½œä¸ºæ‰‹ç»­è´¹ï¼Œå‚¨å¤‡åœ¨ä»£å¸æ± ä¸­
- æ­¤å¤„ï¼Œæ‰‹ç»­è´¹ä¼šç´¯ç§¯åˆ°æµåŠ¨æ€§æ± ä¸­ï¼Œéšç€æ—¶é—´çš„æ¨ç§»ï¼ŒæµåŠ¨æ€§ä»½é¢çš„ä»·å€¼ä¼šå¢åŠ ã€‚
- ```addLiquidity```æ“ä½œåï¼Œç”¨æˆ·çš„æµåŠ¨æ€§ä»½é¢ä¼šå¢åŠ 
- ```removeLiquidity```æ“ä½œåï¼Œç”¨æˆ·çš„æµåŠ¨æ€§ä»½é¢ä¼šå‡å°‘ï¼ŒåŒæ—¶è¿”å›ç»™ç”¨æˆ·ä»£å¸